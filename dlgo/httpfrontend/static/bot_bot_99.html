<!DOCTYPE HTML>

<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Board</title>

    <!-- Modules -->
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <script src='iframeSizer.contentWindow.min.js'></script>
    <script type='text/javascript' src='./jgoboard-latest.js'></script>
    <script type='text/javascript' src='large/board.js'></script>

    <!--  CSS  -->
    <style>
     body {
       font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
       text-align: center;
     }
     .center {
       margin-left:auto;
       margin-right:auto;
     }
    </style>
  </head>
  <body>

    <!-- Page HTML    -->
    <br>
    <div style='font-size:20pt'>Bot playing Bot</div>
    <div id='board'></div>
    <div>
      <div id='status'>Black to play</div>
    </div>
    <br>
    <div>
      <a id='btn_next' class='btn btn-default' style='font-size:20pt'>Next</a>
      <a id='btn_play' class='btn btn-default' style='font-size:20pt'>Play</a>
      <a id='btn_pause' class='btn btn-default' style='font-size:20pt'>Pause</a>
      <a id='btn_score' class='btn btn-default' style='font-size:20pt'>Score</a>
    </div>
    <br>
    <div> <a id='btn_new' class='btn btn-default' style='font-size:20pt'>New Game</a></div>

    <!-- Our own JS -->
    <script type='text/javascript'>

     var BOARD_SIZE = 9
     var jrecord = new JGO.Record(BOARD_SIZE)
     var jboard = jrecord.jboard
     var jsetup = new JGO.Setup(jboard, JGO.BOARD.largeWalnut)
     var player = JGO.BLACK // next player
     var ko = false, lastMove = false // ko coordinate and last move coordinate
     var lastHover = false, lastX = -1, lastY = -1 // hover helper vars
     var record = []
     var colnames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N']
     var waitingForBot = false

     //--------------------------------
     function coordsToString(point) {
       var row = (BOARD_SIZE - 1) - point.j
       var col = point.i
       return colnames[col] + ((row + 1).toString())
     } // coordsToString()

     //--------------------------------------
     function stringToCoords(move_string) {
       var colStr = move_string.substring(0, 1)
       var rowStr = move_string.substring(1)
       var col = colnames.indexOf(colStr)
       var row = BOARD_SIZE - parseInt(rowStr, 10)
       return new JGO.Coordinate(col, row)
     } // stringToCoords()

     //-----------------------------------
     function applyMove(player, coord) {
       var play = jboard.playMove(coord, player, ko)

       if (play.success) {
         record.push(coordsToString(coord))
         node = jrecord.createNode(true)
         node.info.captures[player] += play.captures.length // tally captures
         node.setType(coord, player) // play stone
         node.setType(play.captures, JGO.CLEAR) // clear opponent's stones

         if (lastMove) {
           node.setMark(lastMove, JGO.MARK.NONE) // clear previous mark
         }
         if (ko) {
           node.setMark(ko, JGO.MARK.NONE) // clear previous ko mark
         }
         node.setMark(coord, JGO.MARK.CIRCLE) // mark move
         lastMove = coord

         if(play.ko)
           node.setMark(play.ko, JGO.MARK.CIRCLE) // mark ko, too
         ko = play.ko
       } else alert('Illegal move: ' + play.errorMsg)
     } // applyMove()

     //------------------------
     function waitForBot() {
       console.log('Waiting for bot...')
       document.getElementById('status').style.display = 'none'
       waitingForBot = true
     } // waitForBot()

     //--------------------------------
     function stopWaiting(botmove) {
       var text = 'Bot plays ' + botmove
       if (botmove == 'pass') {
         text = 'Bot passes'
       } else if (botmove == 'resign') {
         text = 'Bot resigns'
       }
       document.getElementById('status').innerHTML = text
       document.getElementById('status').style.display = 'block'
       waitingForBot = false
     } // stopWaiting()

     // Get next move from the bot and show on board
     //-----------------------------------------------
     function getBotMove() {
       fetch( '/select-move/random', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
         },
         body: JSON.stringify( {'board_size': BOARD_SIZE, 'moves': record}),
       }).then( function(response) {
         response.json().then( function(data) {
           if (data.bot_move == 'pass' || data.bot_move == 'resign') {
             record.push( data.bot_move)
           }
           else {
             var botCoord = stringToCoords( data.bot_move)
             applyMove( player, botCoord)
             player =  (player == JGO.BLACK) ? JGO.WHITE : JGO.BLACK
           }
         })
       }).catch( function(error) {
         console.log( error)
       })
     } // getBotMove()

     //------------------------------
     function set_btn_handlers() {
       $('#btn_new').click( function() {
         console.log( 'new clicked')
         jrecord.jboard.clear()
         jrecord.root = jrecord.current = null
         jrecord.info = {}
         record = []
         waitingForBot = false
         return false })
       $('#btn_next').click( function() {
         console.log( 'next clicked')
         getBotMove()
         return false })
       $('#btn_play').click( function() {
         console.log( 'play clicked')
         return false })
       $('#btn_pause').click( function() {
         console.log( 'pause clicked')
         return false })
       $('#btn_score').click( function() {
         console.log( 'score clicked')
         return false })
     } // set_btn_handlers()

     //------------------
     function main() {
       set_btn_handlers()

       jsetup.setOptions({stars: {points:5}})
       jsetup.create('board', function(canvas) {})
       /* canvas.addListener('click', function(coord, ev) {
        *   if (waitingForBot) {
        *     return;
        *   }
        *   var opponent = (player == JGO.BLACK) ? JGO.WHITE : JGO.BLACK;

        *   if(ev.shiftKey) { // on shift do edit
        *     if(jboard.getMark(coord) == JGO.MARK.NONE)
        *       jboard.setMark(coord, JGO.MARK.SELECTED);
        *     else
        *       jboard.setMark(coord, JGO.MARK.NONE);

        *     return;
        *   }

        *   // clear hover away - it'll be replaced or then it will be an illegal move
        *   // in any case so no need to worry about putting it back afterwards
        *   if(lastHover)
        *     jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

        *   lastHover = false;

        *   console.log('Human', coordsToString(coord));
        *   applyMove(JGO.BLACK, coord);

        *   waitForBot();
        *   fetch('/select-move/random', {
        *     method: 'POST',
        *     headers: {
        *       'Content-Type': 'application/json',
        *     },
        *     body: JSON.stringify({'board_size': BOARD_SIZE, 'moves': record}),
        *   }).then(function(response) {
        *     if (!waitingForBot) {
        *       console.log('Got response but not waiting for one');
        *       return;
        *     }
        *     response.json().then(function(data) {
        *       if (data.bot_move == 'pass' || data.bot_move == 'resign') {
        *         record.push(data.bot_move);
        *       } else {
        *         var botCoord = stringToCoords(data.bot_move);
        *         applyMove(JGO.WHITE, botCoord);
        *       }
        *       stopWaiting(data.bot_move);
        *     });
        *   }).catch(function(error) {
        *     console.log(error);
        *     stopWaiting(data.bot_move);
        *   });
        * });
        */
         /* canvas.addListener('mousemove', function(coord, ev) {
          *   if(coord.i == -1 || coord.j == -1 || (coord.i == lastX && coord.j == lastY))
          *     return;

          *   if(lastHover) // clear previous hover if there was one
          *     jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

          *   lastX = coord.i;
          *   lastY = coord.j;

          *   if(jboard.getType(coord) == JGO.CLEAR && jboard.getMark(coord) == JGO.MARK.NONE) {
          *     jboard.setType(coord, player == JGO.WHITE ? JGO.DIM_WHITE : JGO.DIM_BLACK);
          *     lastHover = true;
          *   } else
          *   lastHover = false;
          * });

          * canvas.addListener('mouseout', function(ev) {
          *   if(lastHover)
          *     jboard.setType(new JGO.Coordinate(lastX, lastY), JGO.CLEAR);

          *   lastHover = false;
          * });*/
       //});
     } // main()

     main()
    </script>
  </body>
</html>
